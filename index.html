<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Animated Earthquake Map</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id="map" style="width:100%;height:90vh;"></div>

<script>

const dataUrl = "https://earthquakestorage123.blob.core.windows.net/bronze/latest_earthquake_data.json?sp=r&st=2025-12-07T17:19:27Z&se=2026-01-08T01:34:27Z&spr=https&sv=2024-11-04&sr=b&sig=7%2F0OtVDd5bllUbWMqVtQUls4vwcs%2BYna1fMaO0u8dLw%3D";

fetch(dataUrl)
  .then(response => response.json())
  .then(features => {

      // Group by date
      const df = {};
      features.forEach(f => {
          const dateStr = new Date(f.properties.time).toISOString().split('T')[0];
          if(!df[dateStr]) df[dateStr] = [];
          df[dateStr].push(f);
      });

      const sortedDates = Object.keys(df).sort();

      // Create frames for each day
      const frames = sortedDates.map(dateStr => {
          const dayData = df[dateStr];
          return {
              name: dateStr,
              data: [{
                  type: 'scattermapbox',
                  lat: dayData.map(d => d.geometry.coordinates[1]),
                  lon: dayData.map(d => d.geometry.coordinates[0]),
                  mode: 'markers',
                  marker: {
                      size: dayData.map(d => d.properties.mag * 3),
                      color: dayData.map(d => d.properties.mag),
                      colorscale: 'Turbo',
                      cmin: 0,
                      cmax: 10,
                      opacity: 0.6,
                      colorbar: {
                          title: 'Magnitude',
                          thickness: 15
                      }
                  },
                  text: dayData.map(d => {
                      const t = d.properties.title;
                      return (t.length > 60 ? t.match(/.{1,60}/g).join("<br>") : t)
                             + "<br><b>Date:</b> "+dateStr
                             + "<br><b>Magnitude:</b> "+d.properties.mag;
                  }),
                  hoverinfo: 'text'
              }]
          };
      });

      // Initial trace for first frame
      const firstDayData = df[sortedDates[0]];
      const trace = {
          type: 'scattermapbox',
          lat: firstDayData.map(d => d.geometry.coordinates[1]),
          lon: firstDayData.map(d => d.geometry.coordinates[0]),
          mode: 'markers',
          marker: {
              size: firstDayData.map(d => d.properties.mag * 3),
              color: firstDayData.map(d => d.properties.mag),
              colorscale: 'Turbo',
              cmin: 0,
              cmax: 10,
              opacity: 0.6,
              colorbar: {
                  title: 'Magnitude',
                  thickness: 15
              }
          },
          text: firstDayData.map(d => {
              const t = d.properties.title;
              return (t.length > 60 ? t.match(/.{1,60}/g).join("<br>") : t)
                     + "<br><b>Date:</b> "+sortedDates[0]
                     + "<br><b>Magnitude:</b> "+d.properties.mag;
          }),
          hoverinfo: 'text'
      };

      const layout = {
          mapbox: { style: 'open-street-map', center: {lat:0, lon:0}, zoom:1 },
          margin: { t:0, b:100, l:0, r:0 },  // increase bottom margin so slider labels fit
          sliders:[{
              pad: {t:80, b:10, l:50, r:50},  // add left/right padding so dates don't get cut off
              currentvalue: {prefix: "Date: "},
              steps: sortedDates.map(dateStr => ({
                  label: dateStr,
                  method: 'animate',
                  args: [[dateStr], {mode:'immediate',frame:{duration:500, redraw:true}, transition:{duration:0}}]
              }))
          }],
          updatemenus:[{
              type:'buttons',
              y: 0.05,  // move buttons above bottom
              x: 0.01,
              xanchor: 'left',
              yanchor: 'bottom',
              buttons:[{
                  label:'\u25B6', // Play icon
                  method:'animate',
                  args:[null,{fromcurrent:true,frame:{duration:500, redraw:true},transition:{duration:0}}]
              },{
                  label:'\u275A\u275A', // Pause icon
                  method:'animate',
                  args:[[null],{mode:'immediate',frame:{duration:0,redraw:false},transition:{duration:0}}]
              }]
          }]
      };

      Plotly.newPlot('map', [trace], layout, {responsive:true, scrollZoom:true});
      Plotly.addFrames('map', frames);

  })
  .catch(err => console.error("Error loading JSON:", err));
</script>
</body>
</html>
